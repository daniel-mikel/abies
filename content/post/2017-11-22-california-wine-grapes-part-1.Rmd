---
title: "California Wine  - Part 1"
author: "Daniel Mikel"
date: "2017-11-23T21:13:14-05:00"
output: html_document
runtime: shiny
---

!!!UNDER CONSTRUCTION!!!

The [United States Department of Agriculture](https://www.nass.usda.gov/Statistics_by_State/California/Publications/Grape_Crush/Reports/) publishes contract level price and volume data for California grapes crushed and used for wine. This allows us to see each purchase of a wine variety, what variety, it's price, and the tonnage in the purchased amoung, giving us a disaggregated level data of data ripe for analysis. This is intended to be the first in a series of blog posts analysing the dynamics of the California.

```{r, message = FALSE, echo = FALSE}
library(ggridges)
library(ggjoy)
library(tidyverse)
library(knitr)

gc <- read.csv("/home/dan/Data/NASS/Grape_Crush/gc_csv/all_gc_clean.csv")
district_key <- read.csv("/home/dan/Data/NASS/Grape_Crush/gc_csv/district_key.csv")
gc$District_Number <- as.factor(gc$District_Number)
district_key$District_Number <- as.factor(district_key$District_Number)

gc <- gc %>%
  left_join(district_key)

```

```{r, fig.width = 9}
head(gc[1:6], n = 10)
```

We can see the distribution of tonnage within California's wine regions.

```{r, echo = FALSE, message = FALSE, fig.height = 6, fig.width = 9}
cols <- c("red" = "#F8766D", "white" = "#00BFC4", "raisin" = "#C77CFF", "table" = "#7CAE00", "all wine" = "#190B28")

gc %>%
  filter(Year == 2016) %>%
  group_by(District_Disc, District_Number, Type) %>%
  summarise(Thousand_Tons = sum(Tons)/1000) %>%
  arrange(District_Number) %>%
  ggplot(aes(x = as.factor(District_Number), y = Thousand_Tons, fill = Type)) +
  geom_col() + 
  scale_fill_manual(values = cols) +
  xlab(NULL) + 
  ylab("Thousand Tons Sold") + 
  scale_x_discrete(labels = c("1" = "[1] Mendocino",
                              "2" = "[2] Lake",
                              "3" = "[3] Sonoma",
                              "4" = "[4] Napa",
                              "5" = "[5] Solano",
                              "6" = "[6] North Central Coast",
                              "7" = "[7] Monterey and San Benito",
                              "8" = "[8] San Luis Obispo",
                              "9" = "[9] Northern California",
                              "10" = "[10] Sierra Foothills",
                              "11" = "[11] San Joaquin and Sacramento",
                              "12" = "[12] San Joaquin, Stanislaus, Merced",
                              "13" = "[13] Fresno, Madera, N. Tulare, Mono, Inyo",
                              "14" = "[14] Kern, Kings, S. Tulare",
                              "15" = "[15] L.A. and San Bernardino",
                              "16" = "[16] So Cal",
                              "17" = "[17] Yolo")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))  
```

We can also see a distribution of prices by district. We can see a sharp 

```{r, echo = FALSE, message = FALSE, fig.height = 6, fig.width = 9}
gc %>%
  filter(Base.Price.Per.Ton <= 10000) %>%
  arrange(desc(District_Number)) %>%
  mutate(label = factor(District_Disc, unique(District_Disc))) %>%
  ggplot(aes(x = Base.Price.Per.Ton, y = label, fill = label)) + 
  geom_joy(rel_min_height = 0.005, scale = 2,alpha = 0.5) +
  # scale_x_continuous(breaks = c(0,5000, 10000, 15000)) +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_fill_cyclical(values = c("#66c2a5",
                                 "#fc8d62",
                                 "#8da0cb",
                                 "#e78ac3",
                                 "#a6d854",
                                 "#ffd92f",
                                 "#e5c494")) +
  theme_joy() +
  xlab("Price, Dollars per Ton") +
  ylab("Grape Pricing District")  

```


We can compare historic varieties prices within regions. The interactive graph below allows you to select varieties 

```{r, echo = FALSE, fig.width = 9}

knitr::include_app("https://daniel-mikel.shinyapps.io/gc_variety_embed/", 
                   height = "675px")

```